<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.1">
<title>mlb_simulator.models.game.game_state_transition_probs API documentation</title>
<meta name="description" content="Fit a game state transition matrix. Given the outcome of the at bat, find
a probability distribution for how the game evolves.">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>mlb_simulator.models.game.game_state_transition_probs</code></h1>
</header>
<section id="section-intro">
<p>Fit a game state transition matrix. Given the outcome of the at bat, find
a probability distribution for how the game evolves.</p>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="mlb_simulator.models.game.game_state_transition_probs.GameStateTransitionMatrix"><code class="flex name class">
<span>class <span class="ident">GameStateTransitionMatrix</span></span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class GameStateTransitionMatrix:

    def __init__(self):
        self.name = &#34;GameStateTransitionMatrix&#34;
        self.t_matrix = None

        # get deterministic_transitions
        self._get_deterministic_transition_map()

        # Try loading saved model. If model doesn&#39;t exist or is expired,
        # fit/re-fit model
        try:
            self._load()
        except Exception as _:
            logger.info(f&#34;Refitting {self.name}&#34;)
            self._fit()
            self._save()

        if self.t_matrix is None:
            raise Exception(&#34;Couldn&#39;t get transition probs&#34;)

    def __repr__(self):
        return &#34;GameStateTransitionMatrix&#34;

    def __str__(self):
        return &#34;GameStateTransitionMatrx&#34;

    def __call__(
        self, event: str, stand: str, input_state: TransitionState
    ) -&gt; TransitionStateAfter:
        &#34;&#34;&#34;
        Sample a state transition given input state

        Take the event that occured in the game, the batters stand, the
        current game state, and look up the transition distribution in the
        self.t_matrix variable. Then use the distribution of outcomes to
        sample and return a transition
        &#34;&#34;&#34;

        if event in (&#34;K&#34;, &#34;walk&#34;):
            return self.deterministic_transitions[event][input_state]

        if self.t_matrix is None:
            raise Exception(&#34;Couldn&#39;t get transition probs&#34;)

        distribution = self.t_matrix.loc[(event, stand, input_state)]
        sampled_transition = choices(
            list(distribution.keys()), weights=distribution.values(), k=1
        )[0]
        return sampled_transition

    def _save(self):
        &#34;&#34;&#34;
        Save the fit transition matrix to memory
        &#34;&#34;&#34;

        save_path = os.path.join(get_models_location(), self.name)

        os.makedirs(save_path, exist_ok=True)

        save_path = save_path + f&#34;/{datetime.now().strftime(&#39;%Y%m%d&#39;)}.pkl&#34;

        with open(save_path, &#34;wb&#34;) as file:
            pickle.dump(self.t_matrix, file)

    def _load(self):
        &#34;&#34;&#34;
        Try to load the transition matrix from memory
        &#34;&#34;&#34;

        load_folder = os.path.join(get_models_location(), self.name)

        for file in os.listdir(load_folder):
            date_created_str, file_ext = file.split(&#34;.&#34;)
            if file_ext == &#34;pkl&#34;:
                date_created = datetime.strptime(date_created_str, &#34;%Y%m%d&#34;)

                file_path = os.path.join(load_folder, file)
                if datetime.now() - date_created &gt; timedelta(days=180):
                    # remove old model
                    try:
                        os.remove(file_path)
                    except OSError as e:
                        print(e)
                    self._fit()
                    self._save()
                else:
                    with open(file_path, &#34;rb&#34;) as f:
                        self.t_matrix = pickle.load(f)
                        return None

        raise Exception(&#34;Can&#39;t load model&#34;)

    def _player_tracker(self, row):
        &#34;&#34;&#34;
        keep track of where players are before and after an event:
        map each id to their current position. Can then apply map
        to after state id&#39;s to recover the previous position of the runner
        &#34;&#34;&#34;

        initial_pos = {
            row[&#34;batter&#34;]: &#34;batter&#34;,
            row[&#34;on_1b&#34;]: &#34;1b&#34;,
            row[&#34;on_2b&#34;]: &#34;2b&#34;,
            row[&#34;on_3b&#34;]: &#34;3b&#34;,
        }

        after_pos = {
            &#34;on_1b_after_prev_pos&#34;: initial_pos.get(row[&#34;on_1b_after&#34;], False),
            &#34;on_2b_after_prev_pos&#34;: initial_pos.get(row[&#34;on_2b_after&#34;], False),
            &#34;on_3b_after_prev_pos&#34;: initial_pos.get(row[&#34;on_3b_after&#34;], False),
        }

        return after_pos

    def _encode_states(self, row):
        &#34;&#34;&#34;
        To add state before and state after columns to the dataframe
        &#34;&#34;&#34;

        state_before = TransitionState(
            row[&#34;outs_when_up&#34;], row[&#34;on_1b&#34;], row[&#34;on_2b&#34;], row[&#34;on_3b&#34;]
        )
        state_after = TransitionStateAfter(
            row[&#34;outs_after&#34;],
            row[&#34;on_1b_after_prev_pos&#34;],
            row[&#34;on_2b_after_prev_pos&#34;],
            row[&#34;on_3b_after_prev_pos&#34;],
            row[&#34;runs_scored&#34;],
        )
        return state_before, state_after

    def _counter_to_probs(self, counter):
        &#34;&#34;&#34;
        convert transition counts to categorical probability distribution
        &#34;&#34;&#34;

        total = sum(counter.values())
        return {k: v / total for k, v in counter.items()}

    def _fit(self):
        &#34;&#34;&#34;
        Fit the game state transition prob matrix

        Load Statcast data and encode the game state at each row using the
        GameState namedtuple. Find how the game state changes (runs scored,
        new base positions, new outs) and encode this in a GameStateTransition
        named tuple. Finally,
        &#34;&#34;&#34;

        logger.info(&#34;Loading data&#34;)
        df = get_game_state_t_prob_data()

        logger.info(&#34;Transforming data&#34;)
        # look to next row to find after state. Fill with 3 outs and empty
        # bases if inning changed
        df[&#34;outs_after&#34;] = df.groupby([&#34;game_pk&#34;, &#34;inning&#34;, &#34;inning_topbot&#34;])[
            &#34;outs_when_up&#34;
        ].shift(-1, fill_value=3)

        for col in (&#34;on_1b_after&#34;, &#34;on_2b_after&#34;, &#34;on_3b_after&#34;):
            df[col] = df.groupby([&#34;game_pk&#34;, &#34;inning&#34;, &#34;inning_topbot&#34;])[col[:5]].shift(
                -1, fill_value=np.nan
            )

        # now that we have before and after state, filter to only
        # look at hit outcome events
        df = df[~df[&#34;simplified_outcome&#34;].isna()].reset_index(drop=True)

        # get columns determining prev position of after state runners
        after_states = df.apply(self._player_tracker, axis=1)
        after_states_df = pd.DataFrame(after_states.tolist())
        df = pd.concat([df, after_states_df], axis=1)

        # get now what we have position changes tracked, don&#39;t need player id
        # for the bases and can just represent True for on_1b, False for not.
        for base in range(1, 4):
            df[f&#34;on_{base}b&#34;] = df[f&#34;on_{base}b&#34;].notnull().astype(bool)

        logger.info(&#34;Getting transition probabilities&#34;)
        # encode game states and transitions:
        df[&#34;GameState&#34;], df[&#34;GameStateTransition&#34;] = zip(
            *df.apply(self._encode_states, axis=1)
        )

        # game state transistions
        df = df[[&#34;simplified_outcome&#34;, &#34;stand&#34;, &#34;GameState&#34;, &#34;GameStateTransition&#34;]]

        # group transitions
        transitions_grouped = df.groupby(
            [&#34;simplified_outcome&#34;, &#34;stand&#34;, &#34;GameState&#34;],
        )

        # initialize counter for each group
        transition_counts = transitions_grouped.apply(
            lambda group: Counter(group[&#34;GameStateTransition&#34;]),
            include_groups=False,
        )

        self.t_matrix = transition_counts.apply(self._counter_to_probs)

    def _get_deterministic_transition_map(self):
        deterministic_transitions = {}
        deterministic_transitions[&#34;K&#34;] = {}
        deterministic_transitions[&#34;walk&#34;] = {}

        # Generate all permutations of transition states
        permutations = list(
            product(
                range(3),
                [
                    (x, y, z)
                    for x in (True, False)
                    for y in (True, False)
                    for z in (True, False)
                ],
            )
        )

        for state in permutations:

            first, second, third = state[1]

            transition_state = TransitionState(state[0], first, second, third)

            k_first = &#34;1b&#34; if first else False
            k_second = &#34;2b&#34; if second else False
            k_third = &#34;3b&#34; if third else False

            deterministic_transitions[&#34;K&#34;][transition_state] = TransitionStateAfter(
                transition_state.outs + 1,  # add 1 out
                k_first,  # bases stay same
                k_second,
                k_third,
                0,  # no runs
            )

            # for walks
            new_first, new_second, new_third = &#34;batter&#34;, False, False
            runs_scored = 0
            if first and second and third:
                new_second = &#34;1b&#34;
                new_third = &#34;2b&#34;
                runs_scored = 1
            elif first and not second and not third:
                new_second = &#34;1b&#34;
            elif first and second:
                new_second = &#34;1b&#34;
                new_third = &#34;2b&#34;
            elif first and third:
                new_second = &#34;1b&#34;
                new_third = &#34;3b&#34;
            else:
                if second:
                    new_second = &#34;2b&#34;
                if third:
                    new_third = &#34;3b&#34;

            deterministic_transitions[&#34;walk&#34;][transition_state] = TransitionStateAfter(
                transition_state.outs,  # outs stay the same
                new_first,  # bases defined by logic above
                new_second,
                new_third,
                runs_scored,  # runs scored 0 unless bases loaded
            )

        self.deterministic_transitions = deterministic_transitions</code></pre>
</details>
</dd>
<dt id="mlb_simulator.models.game.game_state_transition_probs.TransitionState"><code class="flex name class">
<span>class <span class="ident">TransitionState</span></span>
<span>(</span><span>outs, on_1b, on_2b, on_3b)</span>
</code></dt>
<dd>
<div class="desc"><p>TransitionState(outs, on_1b, on_2b, on_3b)</p></div>
<h3>Ancestors</h3>
<ul class="hlist">
<li>builtins.tuple</li>
</ul>
<h3>Instance variables</h3>
<dl>
<dt id="mlb_simulator.models.game.game_state_transition_probs.TransitionState.on_1b"><code class="name">var <span class="ident">on_1b</span></code></dt>
<dd>
<div class="desc"><p>Alias for field number 1</p></div>
</dd>
<dt id="mlb_simulator.models.game.game_state_transition_probs.TransitionState.on_2b"><code class="name">var <span class="ident">on_2b</span></code></dt>
<dd>
<div class="desc"><p>Alias for field number 2</p></div>
</dd>
<dt id="mlb_simulator.models.game.game_state_transition_probs.TransitionState.on_3b"><code class="name">var <span class="ident">on_3b</span></code></dt>
<dd>
<div class="desc"><p>Alias for field number 3</p></div>
</dd>
<dt id="mlb_simulator.models.game.game_state_transition_probs.TransitionState.outs"><code class="name">var <span class="ident">outs</span></code></dt>
<dd>
<div class="desc"><p>Alias for field number 0</p></div>
</dd>
</dl>
</dd>
<dt id="mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter"><code class="flex name class">
<span>class <span class="ident">TransitionStateAfter</span></span>
<span>(</span><span>after_outs, after_1b, after_2b, after_3b, runs_scored)</span>
</code></dt>
<dd>
<div class="desc"><p>TransitionStateAfter(after_outs, after_1b, after_2b, after_3b, runs_scored)</p></div>
<h3>Ancestors</h3>
<ul class="hlist">
<li>builtins.tuple</li>
</ul>
<h3>Instance variables</h3>
<dl>
<dt id="mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.after_1b"><code class="name">var <span class="ident">after_1b</span></code></dt>
<dd>
<div class="desc"><p>Alias for field number 1</p></div>
</dd>
<dt id="mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.after_2b"><code class="name">var <span class="ident">after_2b</span></code></dt>
<dd>
<div class="desc"><p>Alias for field number 2</p></div>
</dd>
<dt id="mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.after_3b"><code class="name">var <span class="ident">after_3b</span></code></dt>
<dd>
<div class="desc"><p>Alias for field number 3</p></div>
</dd>
<dt id="mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.after_outs"><code class="name">var <span class="ident">after_outs</span></code></dt>
<dd>
<div class="desc"><p>Alias for field number 0</p></div>
</dd>
<dt id="mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.runs_scored"><code class="name">var <span class="ident">runs_scored</span></code></dt>
<dd>
<div class="desc"><p>Alias for field number 4</p></div>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="mlb_simulator.models.game" href="index.html">mlb_simulator.models.game</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="mlb_simulator.models.game.game_state_transition_probs.GameStateTransitionMatrix" href="#mlb_simulator.models.game.game_state_transition_probs.GameStateTransitionMatrix">GameStateTransitionMatrix</a></code></h4>
</li>
<li>
<h4><code><a title="mlb_simulator.models.game.game_state_transition_probs.TransitionState" href="#mlb_simulator.models.game.game_state_transition_probs.TransitionState">TransitionState</a></code></h4>
<ul class="">
<li><code><a title="mlb_simulator.models.game.game_state_transition_probs.TransitionState.on_1b" href="#mlb_simulator.models.game.game_state_transition_probs.TransitionState.on_1b">on_1b</a></code></li>
<li><code><a title="mlb_simulator.models.game.game_state_transition_probs.TransitionState.on_2b" href="#mlb_simulator.models.game.game_state_transition_probs.TransitionState.on_2b">on_2b</a></code></li>
<li><code><a title="mlb_simulator.models.game.game_state_transition_probs.TransitionState.on_3b" href="#mlb_simulator.models.game.game_state_transition_probs.TransitionState.on_3b">on_3b</a></code></li>
<li><code><a title="mlb_simulator.models.game.game_state_transition_probs.TransitionState.outs" href="#mlb_simulator.models.game.game_state_transition_probs.TransitionState.outs">outs</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter" href="#mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter">TransitionStateAfter</a></code></h4>
<ul class="">
<li><code><a title="mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.after_1b" href="#mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.after_1b">after_1b</a></code></li>
<li><code><a title="mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.after_2b" href="#mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.after_2b">after_2b</a></code></li>
<li><code><a title="mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.after_3b" href="#mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.after_3b">after_3b</a></code></li>
<li><code><a title="mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.after_outs" href="#mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.after_outs">after_outs</a></code></li>
<li><code><a title="mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.runs_scored" href="#mlb_simulator.models.game.game_state_transition_probs.TransitionStateAfter.runs_scored">runs_scored</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.1</a>.</p>
</footer>
</body>
</html>
